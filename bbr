#!/bin/bash

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  TITAN XANMOD ULTIMATE - HYBRID EDITION      â”‚
# â”‚  Engine: Xanmod Kernel (High Performance)    â”‚
# â”‚  Tuning: Titan Logic (Max Throughput)        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Pastikan Root
if [[ $EUID -ne 0 ]]; then
   echo "Script harus dijalankan sebagai root!" 
   exit 1
fi

# === KONFIGURASI WARNA ===
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export YELLOW='\033[0;33m'
export BLUE='\033[0;34m'
export PURPLE='\033[0;35m'
export CYAN='\033[0;36m'
export LIGHT='\033[0;37m'
export NC='\033[0m'

CONFIG_FILE="/etc/sysctl.conf"
BACKUP_FILE="/etc/sysctl.conf.bak.$(date +%F_%T)"

# === FUNGSI INFO SISTEM ===
get_os_info() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_NAME="$PRETTY_NAME"
    else
        OS_NAME=$(uname -s)
    fi
    echo "$OS_NAME"
}

# === TAMPILAN HEADER (DASHBOARD) ===
show_banner() {
    clear
    opsy=$(get_os_info)
    kern=$(uname -r)
    
    # Cek Status TCP
    CURRENT_ALGO=$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo "Unknown")
    
    echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC} ${LIGHT}â—ˆ Informasi Sistem â—ˆ ${NC}${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${YELLOW} âž½ OS         : $opsy ${NC}"
    echo -e "${YELLOW} âž½ Kernel     : $kern ${NC}"
    echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC} ${LIGHT}â—ˆ Status Jaringan â—ˆ ${NC}${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${YELLOW} âž½ TCP Algo   : ${GREEN}${CURRENT_ALGO^^}${NC}"
    if [[ "$kern" == *"xanmod"* ]]; then
        echo -e "${YELLOW} âž½ Engine     : ${CYAN}XANMOD HIGH PERF${NC}"
    else
        echo -e "${YELLOW} âž½ Engine     : ${RED}STANDARD LINUX${NC}"
    fi
    echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo " âž½ TITAN XANMOD ULTIMATE (Kernel + Network Tuning)"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# === SENI SELEBRASI (ART ANDA) ===
show_success_art() {
    local msg="$1"
    clear
    echo -e "${GREEN}â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£€â£€â£€â£´â ·â£¶â£„â£€â €â €â €â €â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¼â£¿â£·â£¾â Ÿâ ›â ‹â â €â ˆâ ‰â ›â£¿â£¦â¡€â €â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â ˆâ ‰â£¡â¡´â ¶â£¤â ¶â ·â£¦â €â£€â£ˆâ »â£¿â¡€â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£³â£¾â£¯â €â €â €â €â£¤â¡ˆâ ‰â ‰â¢¹â¡‡â¢¹â£·â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â£€â£€â €â €â €â €â €â €â €â €â¢˜â£¿â ‹â£¤â¡„â €â£¤â €â¢€â¡ˆâ “â €â£¼â£¿â£„â¢¸â£¿â €â €â €â €â €â €"
    echo -e "â €â €â €â£´â¡¿â ›â ›â£¿â¡§â €â €â €â €â €â €â£¼â¡Ÿâ €â ›â¢¡â¡¾â ‹â €â ¸â ‡â €â €â£¾â£¿â£¿â£¾â Ÿâ €â €â €â €â €â €"
    echo -e "â €â €â¢¸â£¿â €â €â¢°â£¿â ‡â €â €â €â €â €â €â£¿â¡‡â¢€â¡€â ˜â —â €â €â£¤â¡€â €â €â ˆâ ›â¢¿â£¿â €â €â €â €â €â €â €"
    echo -e "â¢€â£ â£¨â£¿â£†â €â ¹â£¿â¡„â €â €â €â €â €â €â¢¸â£¿â ¹â ¯â£¿â£’â£šâ£­â ¿â¡Ÿâ €â €â¢€â£ â£¾â¡¿â €â €â €â €â €â €â €"
    echo -e "â£¿â ›â ‰â ‰â ›â ³â¢¦â¡ˆâ¢¿â£¦â£€â €â €â €â €â €â¢»â£·â¡€â ˜â ›â ƒâ €â €â €â¢€â£´â£¿â£Ÿâ â €â €â €â €â €â €â €â €"
    echo -e "â£¿â ¶â ¶â ¶â ¦â£¤â£¨â¡‡â €â£¿â¡¿â¢·â£¶â£¶â£¦â£´â£¾â£¿â¡Ÿâ ¶â£¤â£€â£€â¡€â¢˜â£¿â â¢¹â¡Ÿâ ¿â£·â£¦â£€â €â €â €â €â €"
    echo -e "â£¿â£¤â£¤â£¤â£€â£€â¢™â¡†â£°â¢â¡‡â €â €â ˆâ ‰â ‰â €â €â ³â£„â¡ˆâ ›â ›â ›â ‹â â£€â£¼â ƒâ €â €â ™â »â£¿â£¦â¡€â €â €"
    echo -e "â£¿â¡…â¢°â£„â ˆâ ‰â£»â¢â¡½â£¸â ƒâ €â €â €â €â €â €â €â €â ˆâ ™â ›â£¦â €â €â¢¹â¡‹â â €â €â €â €â €â ˆâ »â£¿â£†â €"
    echo -e "â ˜â »â£¶â£­â£¿â£¿â£¿â£Ÿâ£±â Ÿâ €â €â €â €â¢€â£ â£¾â ‡â €â €â €â €â¢¹â €â €â ˆâ¡‡â €â €â¢¿â €â €â €â €â €â ˆâ¢»â¡‡"
    echo -e "â €â €â €â ‰â ‰â ‰â ›â ›â ¿â£·â¡–â ’â£¶â¡¿â ›â£¿â €â €â €â €â €â €â ¸â¡‡â €â €â¢¹â €â €â¢¸â¡†â£´â¡–â €â €â €â €â£¿"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¿â¡†â €â €â €â €â €â €â¡‡â €â €â¢¸â¡†â €â ˆâ£¿â â €â €â €â €â£°â ‡"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˜â£¿â£§â¡€â €â €â €â €â €â¡‡â €â €â €â¡‡â£€â£´â¢¿â£€â¡€â €â €â£°â¡â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢ â£¿â¡â ™â ³â ¶â ¦â£¤â£¤â¡‡â €â €â €â ›â ‰â €â¢¸â ‰â ™â¢·â£¾â¡Ÿâ â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ¸â£¿â¡‡â €â €â €â €â €â €â €â €â €â €â €â¢€â£ â£¾â¡†â£€â£¼â¡¿â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢ â£¿â ™â ·â¢¦â£¤â£„â£€â£€â£ â£¤â£¤â¡¶â ¾â ›â ‰â¢¸â£‡â£¹â£¿â ‡â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¾â¡Ÿâ €â €â €â €â ˆâ ‰â ‰â ‰â£„â €â €â €â €â €â €â£¿â£¿â â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¿â¡‡â €â €â €â €â €â €â €â£¾â ƒâ €â €â €â €â €â €â£¿â¡¿â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â¢°â£¿â €â €â €â €â €â €â €â£¼â¡‡â €â €â €â €â €â €â¢ â£¿â¡‡â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â£¾â¡â €â €â €â €â €â €â£¸â£¿â£‡â €â €â €â €â €â €â¢¸â£¿â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â£¼â£¿â â €â €â €â €â €â¢ â£¿â£¿â£¿â €â €â €â €â €â €â£¾â¡¿â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â¢ â£¿â¡‡â €â €â €â €â €â €â£¾â¡¿â¢¸â¡Ÿâ €â €â €â €â €â¢°â£¿â¡‡â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â €â €â €â €â €â €â£¸â£¿â ƒâ¢¸â¡‡â €â €â €â €â €â£¼â£¿â €â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£€â €â €â €â¢€â£´â£¿â ƒâ €â¢¸â£·â£¦â£¤â£¤â£¤â£´â£¿â£·â£¤â¡€â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â£¿â£¿â£¿â£¿â£¿â£¿â£¿â â â €â €â ˆâ »â¡¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡†â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â »â¢¿â¡¿â£¿â£¿â Ÿâ â €â €â €â €â €â €â €â €â €â ‰â ‰â ‰â ‰â ‰â ‰â €â €â €â €â €${NC}"
    echo -e ""
    echo -e "${PURPLE}\n[ $msg ]\n${NC}"
}

print_info() { echo -e "${BLUE}âž½ $1${NC}"; }
print_error() { echo -e "${RED}âœ˜ âœ˜ $1${NC}"; }
print_success() { echo -e "${GREEN}âœ” $1${NC}"; }

# === BAGIAN 1: INSTALL KERNEL XANMOD (ENGINE) ===
install_xanmod() {
    print_info "Memulai Instalasi Kernel Xanmod..."
    
    # Cek apakah sistem Debian/Ubuntu
    if [ ! -f /etc/debian_version ]; then
        print_error "Script ini hanya untuk Debian/Ubuntu!"
        return
    fi

    # 1. Update & Install Tools (FIXED: awk -> gawk)
    print_info "Mengupdate repository..."
    apt-get update -qq && apt-get install wget gpg gawk -y -qq

    # 2. Tambah GPG Key Resmi Xanmod
    print_info "Menambahkan GPG Key Xanmod..."
    wget -qO - https://dl.xanmod.org/gpg.key | gpg --dearmor --yes -o /usr/share/keyrings/xanmod-archive-keyring.gpg

    # 3. Tambah Repository
    print_info "Menambahkan Repository Xanmod..."
    echo 'deb [signed-by=/usr/share/keyrings/xanmod-archive-keyring.gpg] http://deb.xanmod.org releases main' | tee /etc/apt/sources.list.d/xanmod-kernel.list

    # 4. Install Kernel (Pilih Edge untuk performa BBR terbaik)
    print_info "Menginstall Paket Kernel (Ini butuh waktu, mohon sabar)..."
    apt-get update -qq && apt-get install linux-xanmod-edge -y

    # 5. Selesai
    show_success_art "KERNEL XANMOD BERHASIL DIINSTALL"
    echo -e "${RED}PENTING: ANDA HARUS REBOOT (RESTART) VPS SEKARANG!${NC}"
    echo -e "${YELLOW}Setelah Reboot, jalankan script ini lagi dan pilih MENU 2.${NC}"
    
    echo ""
    read -p "Reboot sekarang? (y/n): " reboot_now
    if [[ "$reboot_now" == "y" || "$reboot_now" == "Y" ]]; then
        echo -e "${GREEN}Sistem sedang Reboot... Sampai jumpa!${NC}"
        reboot
        exit 0
    fi
}

# === BAGIAN 2: TITAN NETWORK TUNING (TURBO) ===
apply_titan_tuning() {
    print_info "Menerapkan TITAN Network Logic..."
    
    # 1. Backup
    cp "$CONFIG_FILE" "$BACKUP_FILE"
    
    # 2. Bersihkan Config Lama
    sed -i '/net.core.default_qdisc/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_congestion_control/d' $CONFIG_FILE
    sed -i '/net.core.somaxconn/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_rmem/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_wmem/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_mtu_probing/d' $CONFIG_FILE
    sed -i '/fs.file-max/d' $CONFIG_FILE

    # 3. Load Module BBR (Jika Xanmod sudah ada BBR bawaan, ini aman)
    modprobe tcp_bbr
    echo "tcp_bbr" >> /etc/modules-load.d/modules.conf 2>/dev/null

    # 4. Inject TITAN Parameters (Agresif)
    cat >> $CONFIG_FILE <<EOF
# --- TITAN XANMOD ULTIMATE TUNING ---
# BBR & Queuing
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# Connection Limits (Powerfull)
fs.file-max = 2097152
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 250000

# Buffer Sizes (Speed Stabilizer)
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# VPN Optimization
net.ipv4.tcp_mtu_probing = 1
net.ipv4.ip_forward = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_adv_win_scale = -2
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.tcp_fastopen = 3
EOF
    
    # 5. Apply
    sysctl -p > /dev/null
    
    # 6. Tune Limits (Ulimit)
    if ! grep -q "ulimit -SHn 1000000" /etc/profile; then
        echo "ulimit -SHn 1000000" >> /etc/profile
    fi
    
    show_success_art "TITAN TUNING BERHASIL DITERAPKAN"
}

remove_tuning() {
    sed -i '/TITAN XANMOD/d' $CONFIG_FILE
    # Hapus baris-baris custom
    sed -i '/net.core.default_qdisc/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_congestion_control/d' $CONFIG_FILE
    # Kembalikan ke standar
    echo "net.core.default_qdisc = fq_codel" >> $CONFIG_FILE
    echo "net.ipv4.tcp_congestion_control = cubic" >> $CONFIG_FILE
    sysctl -p > /dev/null
    echo "Tuning dihapus. Kembali ke default."
}

# === MAIN MENU ===
while true; do
    show_banner
    echo -e "${YELLOW} LANGKAH 1: INSTALL ENGINE (KERNEL)${NC}"
    echo -e "${CYAN} [1] ${NC} Install Kernel Xanmod (High Performance)"
    echo ""
    echo -e "${YELLOW} LANGKAH 2: PASANG TURBO (TUNING)${NC}"
    echo -e "${CYAN} [2] ${NC} ðŸš€ Aktifkan TITAN BBR + Ultimate Tuning"
    echo ""
    echo -e "${YELLOW} OPSI LAIN${NC}"
    echo -e "${CYAN} [3] ${NC} Cek Status Kernel & BBR"
    echo -e "${CYAN} [4] ${NC} Hapus Tuning (Restore Default)"
    echo -e "${CYAN} [5] ${NC} Keluar"
    echo ""
    echo -e -n "${CYAN} Pilih Menu [1-5]: ${NC}"
    read choice

    case $choice in
        1) install_xanmod; read -p "Tekan Enter..." ;;
        2) apply_titan_tuning; read -p "Tekan Enter..." ;;
        3) uname -r; sysctl net.ipv4.tcp_congestion_control; read -p "Tekan Enter..." ;;
        4) remove_tuning; read -p "Tekan Enter..." ;;
        5) exit 0 ;;
        *) print_error "Pilihan salah!"; sleep 1 ;;
    esac
done
