#!/bin/bash

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  TITAN TCP OPTIMIZER - DASHBOARD EDITION     â”‚
# â”‚  Fitur: Status Realtime di Header            â”‚
# â”‚  Logic: Powerfull Kernel Tuning              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Pastikan Root
if [[ $EUID -ne 0 ]]; then
   echo "Script harus dijalankan sebagai root!" 
   exit 1
fi

# === KONFIGURASI WARNA ===
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export YELLOW='\033[0;33m'
export BLUE='\033[0;34m'
export PURPLE='\033[0;35m'
export CYAN='\033[0;36m'
export LIGHT='\033[0;37m'
export NC='\033[0m'

CONFIG_FILE="/etc/sysctl.conf"
BACKUP_FILE="/etc/sysctl.conf.bak.$(date +%F_%T)"

# === FUNGSI DETEKSI OS (Agar Tampilan Rapi) ===
get_os_info() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_NAME="$PRETTY_NAME"
    elif command -v lsb_release >/dev/null 2>&1; then
        OS_NAME=$(lsb_release -ds)
    else
        OS_NAME=$(cat /etc/*release | grep -m1 PRETTY_NAME | cut -d'"' -f2)
    fi
    [ -z "$OS_NAME" ] && OS_NAME="Unknown"
    echo "$OS_NAME"
}

# === FUNGSI TAMPILAN HEADER (PENGGANTI ASCII LAMA) ===
show_banner() {
    clear
    # Ambil Data Realtime
    opsy=$(get_os_info)
    kern=$(uname -r)
    
    # Ambil Status TCP
    CURRENT_ALGO=$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo "Unknown")
    CURRENT_QDISC=$(sysctl -n net.core.default_qdisc 2>/dev/null || echo "Unknown")

    # Tampilkan Box Informasi (Gaya Script Swap)
    echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC} ${LIGHT}â—ˆ Informasi Sistem â—ˆ ${NC}${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${YELLOW} âž½ OS         : $opsy ${NC}"
    echo -e "${YELLOW} âž½ Kernel     : $kern ${NC}"
    echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC} ${LIGHT}â—ˆ Status Jaringan â—ˆ ${NC}${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${YELLOW} âž½ TCP Algo   : ${GREEN}${CURRENT_ALGO^^}${NC}"  # ^^ agar huruf besar
    echo -e "${YELLOW} âž½ Queue Disc : ${GREEN}${CURRENT_QDISC^^}${NC}"
    echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo " âž½ Skrip untuk optimasi jaringan VPS (BBR/Hybla)"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo " âž½ Dibuat Oleh: https://t.me/Deki_niswara"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# === FUNGSI SELEBRASI SUKSES (ART ANDA) ===
show_success_art() {
    local msg="$1"
    clear
    echo -e "${GREEN}â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£€â£€â£€â£´â ·â£¶â£„â£€â €â €â €â €â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¼â£¿â£·â£¾â Ÿâ ›â ‹â â €â ˆâ ‰â ›â£¿â£¦â¡€â €â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â ˆâ ‰â£¡â¡´â ¶â£¤â ¶â ·â£¦â €â£€â£ˆâ »â£¿â¡€â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â£€â£€â €â €â €â €â €â €â €â €â¢˜â£¿â ‹â£¤â¡„â €â£¤â €â¢€â¡ˆâ “â €â£¼â£¿â£„â¢¸â£¿â €â €â €â €â €â €"
    echo -e "â €â €â €â£´â¡¿â ›â ›â£¿â¡§â €â €â €â €â €â €â£¼â¡Ÿâ €â ›â¢¡â¡¾â ‹â €â ¸â ‡â €â €â£¾â£¿â£¿â£¾â Ÿâ €â €â €â €â €â €"
    echo -e "â €â €â¢¸â£¿â €â €â¢°â£¿â ‡â €â €â €â €â €â €â£¿â¡‡â¢€â¡€â ˜â —â €â €â£¤â¡€â €â €â ˆâ ›â¢¿â£¿â €â €â €â €â €â €â €"
    echo -e "â¢€â£ â£¨â£¿â£†â €â ¹â£¿â¡„â €â €â €â €â €â €â¢¸â£¿â ¹â ¯â£¿â£’â£šâ£­â ¿â¡Ÿâ €â €â¢€â£ â£¾â¡¿â €â €â €â €â €â €â €"
    echo -e "â£¿â ›â ‰â ‰â ›â ³â¢¦â¡ˆâ¢¿â£¦â£€â €â €â €â €â €â¢»â£·â¡€â ˜â ›â ƒâ €â €â €â¢€â£´â£¿â£Ÿâ â €â €â €â €â €â €â €â €"
    echo -e "â£¿â ¶â ¶â ¶â ¦â£¤â£¨â¡‡â €â£¿â¡¿â¢·â£¶â£¶â£¦â£´â£¾â£¿â¡Ÿâ ¶â£¤â£€â£€â¡€â¢˜â£¿â â¢¹â¡Ÿâ ¿â£·â£¦â£€â €â €â €â €â €"
    echo -e "â£¿â£¤â£¤â£¤â£€â£€â¢™â¡†â£°â¢â¡‡â €â €â ˆâ ‰â ‰â €â €â ³â£„â¡ˆâ ›â ›â ›â ‹â â£€â£¼â ƒâ €â €â ™â »â£¿â£¦â¡€â €â €"
    echo -e "â£¿â¡…â¢°â£„â ˆâ ‰â£»â¢â¡½â£¸â ƒâ €â €â €â €â €â €â €â €â ˆâ ™â ›â£¦â €â €â¢¹â¡‹â â €â €â €â €â €â ˆâ »â£¿â£†â €"
    echo -e "â ˜â »â£¶â£­â£¿â£¿â£¿â£Ÿâ£±â Ÿâ €â €â €â €â¢€â£ â£¾â ‡â €â €â €â €â¢¹â €â €â ˆâ¡‡â €â €â¢¿â €â €â €â €â €â ˆâ¢»â¡‡"
    echo -e "â €â €â €â ‰â ‰â ‰â ›â ›â ¿â£·â¡–â ’â£¶â¡¿â ›â£¿â €â €â €â €â €â €â ¸â¡‡â €â €â¢¹â €â €â¢¸â¡†â£´â¡–â €â €â €â €â£¿"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¿â¡†â €â €â €â €â €â €â¡‡â €â €â¢¸â¡†â €â ˆâ£¿â â €â €â €â €â£°â ‡"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˜â£¿â£§â¡€â €â €â €â €â €â¡‡â €â €â €â¡‡â£€â£´â¢¿â£€â¡€â €â €â£°â¡â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢ â£¿â¡â ™â ³â ¶â ¦â£¤â£¤â¡‡â €â €â €â ›â ‰â €â¢¸â ‰â ™â¢·â£¾â¡Ÿâ â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ¸â£¿â¡‡â €â €â €â €â €â €â €â €â €â €â €â¢€â£ â£¾â¡†â£€â£¼â¡¿â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢ â£¿â ™â ·â¢¦â£¤â£„â£€â£€â£ â£¤â£¤â¡¶â ¾â ›â ‰â¢¸â£‡â£¹â£¿â ‡â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¾â¡Ÿâ €â €â €â €â ˆâ ‰â ‰â ‰â£„â €â €â €â €â €â €â£¿â£¿â â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¿â¡‡â €â €â €â €â €â €â €â£¾â ƒâ €â €â €â €â €â €â£¿â¡¿â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â¢°â£¿â €â €â €â €â €â €â €â£¼â¡‡â €â €â €â €â €â €â¢ â£¿â¡‡â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â£¾â¡â €â €â €â €â €â €â£¸â£¿â£‡â €â €â €â €â €â €â¢¸â£¿â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â£¼â£¿â â €â €â €â €â €â¢ â£¿â£¿â£¿â €â €â €â €â €â €â£¾â¡¿â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â¢ â£¿â¡‡â €â €â €â €â €â €â£¾â¡¿â¢¸â¡Ÿâ €â €â €â €â €â¢°â£¿â¡‡â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â €â €â €â €â €â €â£¸â£¿â ƒâ¢¸â¡‡â €â €â €â €â €â£¼â£¿â €â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£€â €â €â €â¢€â£´â£¿â ƒâ €â¢¸â£·â£¦â£¤â£¤â£¤â£´â£¿â£·â£¤â¡€â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â£¿â£¿â£¿â£¿â£¿â£¿â£¿â â â €â €â ˆâ »â¡¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡†â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â »â¢¿â¡¿â£¿â£¿â Ÿâ â €â €â €â €â €â €â €â €â €â ‰â ‰â ‰â ‰â ‰â ‰â €â €â €â €â €${NC}"
    echo -e ""
    echo -e "${PURPLE}\n[ $msg ]\n${NC}"
    echo -e "${YELLOW}Perubahan diterapkan. Silakan Reboot agar maksimal.${NC}"
}

print_info() { echo -e "${BLUE}âž½ $1${NC}"; }
print_error() { echo -e "${RED}âœ˜ âœ˜ $1${NC}"; }
print_success() { echo -e "${GREEN}âœ” $1${NC}"; }

# === LOGIC POWERFULL ===

check_requirements() {
    # Cek Kernel
    if [[ $(uname -r | cut -d "." -f 1) -lt 4 ]]; then
        print_error "Kernel terlalu tua! Minimal Kernel 4.9 untuk BBR."
        echo "Silakan update kernel OS Anda."
        exit 1
    fi
}

backup_config() {
    print_info "Membuat backup konfigurasi sysctl..."
    cp "$CONFIG_FILE" "$BACKUP_FILE"
    print_success "Backup disimpan: $BACKUP_FILE"
}

clean_sysctl() {
    # Hapus baris yang mungkin duplikat
    sed -i '/net.core.default_qdisc/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_congestion_control/d' $CONFIG_FILE
    sed -i '/net.core.somaxconn/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_rmem/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_wmem/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_mtu_probing/d' $CONFIG_FILE
    sed -i '/fs.file-max/d' $CONFIG_FILE
}

apply_bbr() {
    print_info "Mengaktifkan TCP BBR + Full Stack Optimization..."
    clean_sysctl
    
    # Load Module
    modprobe tcp_bbr
    echo "tcp_bbr" >> /etc/modules-load.d/modules.conf 2>/dev/null

    cat >> $CONFIG_FILE <<EOF
# --- TITAN NETWORK OPTIMIZER (BBR) ---
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
fs.file-max = 2097152
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.core.netdev_max_backlog = 250000
net.core.somaxconn = 65535
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.tcp_mtu_probing = 1
net.ipv4.ip_forward = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_adv_win_scale = -2
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_notsent_lowat = 16384
EOF
    sysctl -p > /dev/null
    show_success_art "TCP BBR SUKSES DIAKTIFKAN"
}

apply_hybla() {
    print_info "Mengaktifkan TCP Hybla (Mode Satelit/Ping Tinggi)..."
    clean_sysctl
    
    modprobe tcp_hybla
    echo "tcp_hybla" >> /etc/modules-load.d/modules.conf 2>/dev/null

    cat >> $CONFIG_FILE <<EOF
# --- TITAN NETWORK OPTIMIZER (HYBLA) ---
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = hybla
fs.file-max = 1000000
net.ipv4.tcp_low_latency = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.ip_forward = 1
EOF
    sysctl -p > /dev/null
    show_success_art "TCP HYBLA SUKSES DIAKTIFKAN"
}

restore_default() {
    print_info "Mengembalikan ke Default (Cubic)..."
    clean_sysctl
    
    cat >> $CONFIG_FILE <<EOF
# --- TITAN DEFAULT ---
net.core.default_qdisc = fq_codel
net.ipv4.tcp_congestion_control = cubic
EOF
    sysctl -p > /dev/null
    show_success_art "KEMBALI KE DEFAULT (CUBIC)"
}

# === MAIN MENU ===
check_requirements
while true; do
    show_banner
    echo -e "${YELLOW} [1] ${NC} ðŸš€ Aktifkan TCP BBR (Recommended for VPN/Xray)"
    echo -e "${YELLOW} [2] ${NC} ðŸ“¡ Aktifkan TCP Hybla (Ping Tinggi/Satelit)"
    echo -e "${YELLOW} [3] ${NC} â†º  Restore Default (Cubic)"
    echo -e "${YELLOW} [4] ${NC} Keluar"
    echo ""
    echo -e -n "${CYAN} Pilih Menu [1-4]: ${NC}"
    read choice

    case $choice in
        1) backup_config; apply_bbr; read -p "Tekan Enter..." ;;
        2) backup_config; apply_hybla; read -p "Tekan Enter..." ;;
        3) restore_default; read -p "Tekan Enter..." ;;
        4) exit 0 ;;
        *) print_error "Pilihan salah!"; sleep 1 ;;
    esac
done
